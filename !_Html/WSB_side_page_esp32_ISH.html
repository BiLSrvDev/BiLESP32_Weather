<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css>
<link rel=stylesheet href=https://atuin.ru/demo/ui-slider/jquery-ui.css>
<link rel=stylesheet href=https://rakosel.github.io/WSB_side_loaded_css.css>
<title>WSB_Server</title>
</head>
<body>
<div class=container-fluid>
<div class="row flex-xl-nowrap">
<div id=sidebar_sensor class="bsn0 collapse col-md-4 col-xl-4" style=background-color:#DFDBDB>
<div class="container-fluid shadow p-3 mb-5 bg-white rounded">
<ul class=navbar-nav>
<li class="nav-item bg-primary rounded">
<span class=text-light>WSB_Server [DEMO VERSION]</span>
</li>
<li class=nav-item>
<span>Статус сервера:</span>
<span class="pst0 navbar-brand badge mb-0 text-white">
</span>
</li>
<li class=nav-item>
 Меню: <button class="bt0st1 navbar-dark bg-info" type=button aria-expanded=false aria-label="Навигация по сенсорам">
<span class=navbar-toggler-icon>
</span>
</button>
</li>
</ul>
<hr>
<div class=sidebar-heading>
Датчики температуры: </div>
<div id=list-example class="list-group list-group-flush">
<a class=navia href=#srednie onclick=clbtn0()>
Средние значения</a>
<a class=navia href=#lm75 onclick=clbtn0()>
LM_75</a>
<a class=navia href=#dht22 onclick=clbtn0()>
DHT22</a>
<a class=navia href=#bme280 onclick=clbtn0()>
BME280</a>
<a class=navia href=#sht3x onclick=clbtn0()>
SHTx</a>
<a class=navia href=#htu21 onclick=clbtn0()>
HTU21</a>
<a class=navia href=#expmeas onclick=sub_measure()>
Экспорт замеров</a>
<a class=navia href=#clrmeas onclick=clr_measure()>
Очистить замеры</a>
<div class=sidebar-heading>
Дневной свет: </div>
<a class=navia href=#temt onclick=clbtn0()>
TEMT6000</a>
<div class=sidebar-heading>
Обмен по WEB-UART:</div>
<a class=navia href=#esp_uart onclick=clbtn0()>
WEB-UART</a>
<br>
<div class="custom-control custom-switch">
<input type=checkbox class="custom-control-input swdeb" id=auza>
<label class="custom-control-label swdebl" for=auza>
Включить режим настройки</label>
<span class="pst1 navbar-brand badge mb-0 text-white">
</span>
</div>
<div class="sidebar-heading sideset collapse hide">
<div class=sidebar-heading>
Настройка датчиков: </div>
<a class=navia href=#list-item-4>
LM_75</a>
<a class=navia href=#list-item-3>
BME280</a>
<a class=navia href=#list-item-4>
SHTx</a>
<a class=navia href=#list-item-4>
Задать время</a>
</div>
<ul class=navbar-nav>
<li class=nav-item>
<p class="lead mb-0">
Время сервера:</p>
<p class="ptime lead mb-0">
</p>
</li>
</ul>
</div>
</div>
</div>
<div class="mc1 col-md-8 col-xl-8 bd-content" role=main>
<nav class="navbar navbar-expand navbar-dark border-bottom sticky-top" style=background-color:#563d7c>
<div class="collapse navbar-collapse" id=navbarNavAltMarkup>
<p class="navbar-brand mb-0 text-warning">WSB_Server</p>
<div class=container-fluid>
<ul class="navbar-nav mr-auto">
<li class=nav-item>
<span class="navbar text-white">Меню:</span>
</li>
<li class=nav-item>
<button class="bt0st bg-primary" type=button data-toggle=collapse data-target=#sidebar_sensor aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Навигация по сенсорам">
<span class=navbar-toggler-icon>
</span>
</button>
</li>
<li class="nav-item d-none d-md-block">
<span class="navbar text-white tst0">
Статус сервера:</span>
</li>
<li class="nav-item d-none d-md-block">
<span class="navbar pst0 badge lead text-white">
</span>
</li>
</ul>
</div>
</div>
</nav>
<div class="macnt text-white row-*-* mx-auto" style=background-color:#575757>
</div>
<div class="setcnt text-white row-*-* shadow border mb-5 mx-auto collapse hide" style=background-color:#575757>
</div>
<div class="container-fluid shadow border">
<p class="h5 modal-title text-center" id=esp_uart>
Обмен по WEB-UART</p>
<hr>
<form id=esp_uart_form class=mb- novalidate>
<p>
Input</p>
<div class="form-group col">
<button type=button id=btn0 class="btn btn-primary" onclick=erxclr_uart()>
Очистить Input</button>
</div>
<textarea id=esp_tx rows=10 cols=80 class=form-control>
</textarea>
<br>
<div class="form-group col">
<button type=button id=btn1 class="btn btn-primary" onclick=submit_uart()>
SEND UART(D8)</button>
<span>
Передавать команды без LUA </span>
<input type=checkbox name=uart_get_ch id=uart_get_ch>
</div>
<div class="form-group col">
<button type=button id=btn2 class="btn btn-primary" onclick=etxclr_uart()>
Очистить OUTPUT</button>
</div>
<p>
Output</p>
<textarea id=esp_urx rows=10 cols=80 class=form-control>
</textarea>
<br>
</form>
<div class=container>
<div class=row>
<div class="card border-light mb-3 col-md-9 offset-md-2 border shadow">
<div class="card-header text-center">
Version & about</div>
<p class=card-text>
WSB_Server<strong>
&reg;</strong>
 3.1.3 build Official version by <strong>
Farid_WSB&copy;Rakosel&trade;</strong>
 beta version from 30.09.2018-16.10.2021 based by Lua 5.3.0 on SDK 3.1.1 with NodeMCU 3.1.1 &copy; 2018 - 2021</p>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
<script src=https://code.jquery.com/jquery-3.3.1.min.js>
</script>
<script src=https://unpkg.com/current-device/umd/current-device.min.js>
</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-touch-events/2.0.0/jquery.mobile-events.min.js>
</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js>
</script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js>
</script>

<script type="text/javascript">
	$(".macnt").load('https://bilsrv.github.io/WSBSrvWeatherPub/WSB_page_main.html').html();
</script>
<!--<script type=text/javascript charset=utf-8 src=https://rakosel.github.io/wsb_script_2_2_1.js></script>!-->
<!-- <script type="text/javascript" src="https://bilsrv.github.io/WSBSrvWeatherPub/wsb_script_2_2_2.js" defer></script>  !-->
<script type="text/javascript">

var stopAll = false,
	ra,
	rs,
	subwdeb = false,
	lines_in,
	i,
	url;
var maOBJ, seOBJ, bmeOBJ;
var str_out = "",
	str_out1 = "";
var uart_json = {};
var temp_json = {};
var input_lm75 = {};
var scrPos = 0,
	ovShBtn0 = false;
var ast = 0;
var ua_mode = 0;
var tmranim = 2000; // animate [s]

let T_arr = new Array();
let P_arr = new Array();
let H_arr = new Array();
let temp_arr = new Array();
	
T_arr = [0,1,2,4,5,16,17,20];
H_arr = [3,8,9,18,19,21];
P_arr = [6,7,12,13];
var j_T = 0.0;
var j_H = 0.0;
var j_P = 0.0;
// reverse panelki dlya debug
var sds, mds, sets;
sds = $(".sideset");
mds = $(".macnt");
sets = $(".setcnt");
cnftmp = $(".scntf");
// rtc time auto from server
//sht30_1

    //fetch("/temp_out", "GET", txjstmp, 10);
	//	 $("#temperature").val(j_T.toString().substring(0, 6));
	//	 $("#humudity").val(j_H.toString().substring(0, 6));
	//	 $("#pressure").val(j_P.toString().substring(0, 6));
    //console.log(maOBJ);

// zapros temperature
function sub_grad() {
    maOBJ = $("#tmpo").serializeArray();
//	newPost = {
//	  username: 'example',
//	  passwd: 'param2',
//	  userid: '1',
//	}
	
newPost = {
  "array": [
    1,
    2,
    3
  ],
  "sername": true,
  "passwd": "gold",
  "userid": null,
  "object": {
    "a": "b",
    "c": "d"
  },
  "string": "Hello World"
}

	
	// RxAJAX
	url1 = "/temp_out.json?" + encodeURIComponent(JSON.stringify(newPost)) + "&";
	fetch1(url1, "GET", TxMAINAJAX, 10);

//fetch("/temp_out", {
//  method: 'GET', // Здесь так же могут быть GET, PUT, DELETE
//  headers: {
    // Добавляем необходимые заголовки
//    'Content-type': 'application/json; charset=UTF-8',
//  },
//})
//  .then((response) => response.text())
//  .then((data) => {
//    console.log(data)
    // {title: "foo", body: "bar", userId: 1, id: 101}
//  })
	
	
	//var url1 = "/temp_out.json?username=example&passwd=param2";
        //fetch1(url1, "GET", txjstmp, 10);
	

	
	//url1 = "/input_bme280_2.json?" + encodeURIComponent(JSON.stringify(newPost)) + "&";
	//fetch1(url1, "GET", txjstmp, 10);
	

}
	//  .then((newPost) => {
    //console.log(newPost)
    // {title: "foo", body: "bar", userId: 1, id: 101}
  //})

// cont: TEMP, RTC, DEBUG + Settings
function TxMAINAJAX(s, d) {
    var as1 = $(".pst1");
    var as0 = $(".pst0");
//    console.log(d);
    if (s != 200) {
        as0.removeClass("badge-success");
        as0.addClass("badge-danger");
        as0.text("Нет связи");
        as1.removeClass("badge-success");
        as1.addClass("badge-danger");
        as1.text("Нет связи");
        $(".swdeb").removeAttr("disabled");
        ftmpd();
        //console.log("Connection proplem!");
        return 0;
        //clearTimeout(rs.handle);
    } else {
        as0.removeClass("badge-danger");
        as1.removeClass("badge-danger");
        as0.addClass("badge-success");
        as1.addClass("badge-success");
        as0.text("ОК ");
		as1.text("ОК ");
        if (typeof d === "string") {
            console.log(d);
            try {
                temp_json = JSON.parse(d);
                //console.log(s, temp_json);
            } catch (e) {
                // ftvall - form clear
                ftvall("");
                //console.log(s, e.message);
                return 0;
            }
        } else {
            //console.log("d not string");
            ftvall("");
            return 0;
        }
    }
	j=1;ii=0;
	console.log("temp_json[temp])");
    if (temp_json["temp"]) {
	    console.log(temp_json["temp"]);
		j_T = 0.0; j_H = 0.0; j_P = 0.0;
		T_cnt = 0; H_cnt = 0; P_cnt = 0;
        for (i = 3; i <= maOBJ.length && (i - 3) <= temp_json.temp.length; i++) {
            try {
		console.log("temp_json:", parseFloat(temp_json.temp[T_arr[ii]]));
            
				if(ii<T_arr.length && parseFloat(temp_json.temp[T_arr[ii]]) != NaN && temp_json.temp[T_arr[ii]] != "#ERR")
				{
					tmpf = parseFloat(temp_json.temp[T_arr[ii]]);
					if(tmpf<0)
					{j=-1;}
					else
					{j=j*j}
					j_T+=Math.abs(tmpf);T_cnt++; 
					//console.log("a5 "+" "+ii+" "+parseFloat(temp_json.temp[T_arr[ii]])+" "+T_arr[ii]+" "+temp_arr[ii]+" "+T_arr+" "+T_cnt);
				}
				if(ii<H_arr.length && parseFloat(temp_json.temp[H_arr[ii]]) != NaN && temp_json.temp[H_arr[ii]] != "#ERR")
				{
					tmpf = parseFloat(temp_json.temp[H_arr[ii]]);
					H_cnt++;
					if(tmpf>=99.0)
					{H_cnt--;}
					else if(H_arr[ii] == 3)
					{j_H+=(parseFloat(temp_json.temp[H_arr[ii]])-9.5);}
					else 
					{j_H+=parseFloat(temp_json.temp[H_arr[ii]]);}
				}
				if(ii<P_arr.length && parseFloat(temp_json.temp[P_arr[ii]]) != NaN && temp_json.temp[P_arr[ii]] != "#ERR")
				{
					j_P+=parseFloat(temp_json.temp[P_arr[ii]]);P_cnt++;
				}	
					ii++;
				}
				catch (e) 
				{
					console.log(e);
				}
				$("#" + maOBJ[i].name).val(temp_json.temp[i - 3]);
				}
			}

			j_T=(j_T*j)/T_cnt; j_H=j_H/H_cnt; j_P=j_P/P_cnt;
	}
function sdmc_sh() {
    mds.removeClass("collapse show");
    mds.addClass("collapse hide");
    sds.removeClass("collapse hide");
    sds.addClass("collapse show");
    sets.removeClass("collapse hide");
    sets.addClass("collapse show");
}

function sdmc_rm() {
    mds.removeClass("collapse hide");
    mds.addClass("collapse show");
    sds.removeClass("collapse show");
    sds.addClass("collapse hide");
    sets.removeClass("collapse show");
    sets.addClass("collapse hide");
}

function ftvall(cl) {
    for (i = 0; i < maOBJ.length; i++) {
        $("#" + maOBJ[i].name).val(cl);
        $("#" + maOBJ[i].name)
			.removeClass("is-invalid")
			.html();
        $("#" + maOBJ[i].name)
			.removeClass("is-valid")
			.html();
    }
}

function ftmpd() {
    for (i = 0; i < maOBJ.length; i++) {
        $("#" + maOBJ[i].name)
			.removeClass("is-invalid")
			.html();
        $("#" + maOBJ[i].name)
			.removeClass("is-valid")
			.html();
    }
}

function spt0() {
    var lines = $("#esp_tx")
		.val()
		.replace(/^[\n]+$/g, "")
		.split(/[\n]+/);
    return lines;
}

function smgh() {
    if (!device.mobile()) {
        $(".bt0st").click();
    }
}

// MENU - dublirovanmie
$(".bt0st1").click(function bjst1() {
    $(".bt0st").click();
});

function erxclr_uart() {
    $("#esp_tx").val("");
}

function etxclr_uart() {
    $("#esp_urx").val("");
    str_out1 = "";
}


function rm_b() {
    // remove deviser HD
    $(".mc1").removeClass("col-md-8 col-xl-8").html();
    $(".bsn0").removeClass("col-md-4 col-xl-4").html();
    $(".mc1").removeClass("noscroll collapse hide");
    $(".mc1").addClass("col-12").html();
}

function sh_b() {
    // deviser HD
    $(".mc1").remove("col-12").html();
    $(".mc1").addClass("col-md-8 col-xl-8").html();
    $(".bsn0").addClass("col-md-4 col-xl-4").html();
}

function rms_b() {
    //$('.bsn0').removeClass('col-12').html();
    $(".bsn0").removeClass("col-12 overlay").html();
    $(".mc1").removeClass("noscroll collapse hide");
}

function shs_b() {
    $(".bsn0").addClass("col-12 overlay").html();
    $(".mc1").addClass("noscroll collapse hide").html();
}



function fetch1(url, method, callback, time_out) {
    //console.log(url);
    var xhr = new XMLHttpRequest();
    xhr.onloadend = function () {
        callback(xhr.status, xhr.responseText);
    };
    xhr.ontimeout = function () {
        callback(-1, null);
    };
    xhr.open(method, url, true);
    xhr.setRequestHeader("Accept", "text/html");
// text/plain	;charset=UTF-8
	xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8"); 
    xhr.timeout = time_out * 200;
    xhr.send();
}


function txjs_ua(s, d) {
    seOBJ = $("#scntf").serializeArray();
    $("#btn1").prop("disabled", false);
    if (s != 200) {
        str_out1 += "Send command error" + "\n";
        //clearTimeout(rs.handle);
        //console.log("Connection proplem!");
    } else {
        if (typeof d === "string") {
            //console.log("priem ok!");
            try {
                uart_json = JSON.parse(d);
            } catch (e) {
                //console.log(e);
                return 0;
            }
        } else {
            uart_json.uart_out = "null";
            uart_json.uart_in = "null";
        }
        //console.log(uart_json);
        if (uart_json.uart_out == "") {
            str_out1 += "ACK" + "\n";
        } else {
            str_out1 += uart_json.uart_out + "\n";
        }
        //console.log(uart_json.uart_out);
    }
    var esp_uart_out_val = $("#esp_urx");
    if (esp_uart_out_val.val() != "") {
        esp_uart_out_val.val(esp_uart_out_val.val() + str_out1);
    } else {
        esp_uart_out_val.val(str_out1);
    }
    //console.log(str_out1);
    str_out1 = "";
    //clearTimeout(rs.handle);
    //rs = to(refr, 3);
    //refr();
}


	
window.onload = function () {
	
$(".bt0st").attr("value", "off");
$(".navia").addClass("list-group-item list-group-item-action bg-light border");
$("#esp_tx").val("wsbuser.prints(node.heap());");
$("#esp_urx").val("");
smgh();
	
}
</script>
